# Makefile cho Backend (Go)

# Colors for output
GREEN  := \033[0;32m
YELLOW := \033[0;33m
RED    := \033[0;31m
NC     := \033[0m # No Color

# Variables
APP_NAME := fullstack-backend
MAIN_PATH := cmd/api/main.go
BUILD_DIR := bin

.PHONY: help run build test clean deps tidy migrate-up migrate-down docker-db

# Default target - hi·ªÉn th·ªã help
help:
	@echo "$(GREEN)Available commands:$(NC)"
	@echo "  $(YELLOW)make run$(NC)          - Ch·∫°y server (development mode)"
	@echo "  $(YELLOW)make build$(NC)        - Build binary"
	@echo "  $(YELLOW)make test$(NC)         - Ch·∫°y tests"
	@echo "  $(YELLOW)make clean$(NC)        - X√≥a build files"
	@echo "  $(YELLOW)make deps$(NC)         - C√†i ƒë·∫∑t dependencies"
	@echo "  $(YELLOW)make tidy$(NC)         - Tidy go modules"
	@echo "  $(YELLOW)make docker-db$(NC)    - Ch·∫°y PostgreSQL trong Docker"
	@echo "  $(YELLOW)make migrate-up$(NC)   - Ch·∫°y database migrations"
	@echo "  $(YELLOW)make set-admin$(NC)    - Set user th√†nh admin (EMAIL=user@example.com)"

# Ch·∫°y server
run:
	@echo "$(GREEN)üöÄ Starting server...$(NC)"
	@go run $(MAIN_PATH)

# Build binary
build:
	@echo "$(GREEN)üî® Building $(APP_NAME)...$(NC)"
	@mkdir -p $(BUILD_DIR)
	@go build -o $(BUILD_DIR)/$(APP_NAME) $(MAIN_PATH)
	@echo "$(GREEN)‚úÖ Build complete: $(BUILD_DIR)/$(APP_NAME)$(NC)"

# Ch·∫°y binary ƒë√£ build
start:
	@echo "$(GREEN)üöÄ Starting $(APP_NAME)...$(NC)"
	@./$(BUILD_DIR)/$(APP_NAME)

# Ch·∫°y tests
test:
	@echo "$(GREEN)üß™ Running tests...$(NC)"
	@go test -v ./...

# Ch·∫°y tests v·ªõi coverage
test-coverage:
	@echo "$(GREEN)üß™ Running tests with coverage...$(NC)"
	@go test -v -cover ./...

# Clean build files
clean:
	@echo "$(YELLOW)üßπ Cleaning...$(NC)"
	@rm -rf $(BUILD_DIR)
	@go clean
	@echo "$(GREEN)‚úÖ Clean complete$(NC)"

# C√†i ƒë·∫∑t dependencies
deps:
	@echo "$(GREEN)üì¶ Installing dependencies...$(NC)"
	@go get github.com/gin-gonic/gin
	@go get github.com/lib/pq
	@go get github.com/golang-jwt/jwt/v5
	@go get golang.org/x/crypto/bcrypt
	@echo "$(GREEN)‚úÖ Dependencies installed$(NC)"

# Tidy modules
tidy:
	@echo "$(GREEN)üì¶ Tidying modules...$(NC)"
	@go mod tidy
	@echo "$(GREEN)‚úÖ Modules tidied$(NC)"

# Ch·∫°y PostgreSQL trong Docker
docker-db:
	@echo "$(GREEN)üêò Starting PostgreSQL...$(NC)"
	@cd .. && docker-compose up -d postgres
	@echo "$(GREEN)‚úÖ PostgreSQL started$(NC)"

# D·ª´ng PostgreSQL
docker-db-stop:
	@echo "$(YELLOW)üõë Stopping PostgreSQL...$(NC)"
	@cd .. && docker-compose stop postgres

# Migrate up - Ch·∫°y migrations
migrate-up:
	@echo "$(GREEN)‚¨ÜÔ∏è  Running migrations...$(NC)"
	@if [ -f migrations/001_create_bet_tables.sql ]; then \
		echo "$(GREEN)Running migration: 001_create_bet_tables.sql$(NC)"; \
		cat migrations/001_create_bet_tables.sql | docker exec -i fullstack-postgres psql -U postgres -d hst_db; \
		echo "$(GREEN)‚úÖ Migration completed$(NC)"; \
	else \
		echo "$(RED)‚ùå Migration file not found$(NC)"; \
	fi

# Migrate v·ªõi DBeaver (h∆∞·ªõng d·∫´n)
migrate-guide:
	@echo "$(YELLOW)üìñ H∆∞·ªõng d·∫´n ch·∫°y migrations:$(NC)"
	@echo "  1. M·ªü DBeaver v√† k·∫øt n·ªëi ƒë·∫øn database hst_db"
	@echo "  2. M·ªü SQL Editor (Ctrl+\`)"
	@echo "  3. M·ªü file: backend/migrations/001_create_bet_tables.sql"
	@echo "  4. Copy to√†n b·ªô n·ªôi dung v√† paste v√†o SQL Editor"
	@echo "  5. Ch·∫°y script (F5 ho·∫∑c Ctrl+Enter)"
	@echo ""
	@echo "$(YELLOW)Ho·∫∑c d√πng command line:$(NC)"
	@echo "  cat backend/migrations/001_create_bet_tables.sql | docker exec -i fullstack-postgres psql -U postgres -d hst_db"

# Format code
fmt:
	@echo "$(GREEN)üé® Formatting code...$(NC)"
	@go fmt ./...
	@echo "$(GREEN)‚úÖ Code formatted$(NC)"

# Lint code (c·∫ßn c√†i golangci-lint)
lint:
	@echo "$(GREEN)üîç Linting code...$(NC)"
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run ./...; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  golangci-lint not installed. Run: brew install golangci-lint$(NC)"; \
	fi

# Watch mode - auto restart khi code thay ƒë·ªïi (c·∫ßn c√†i air)
dev:
	@echo "$(GREEN)üëÄ Starting in watch mode...$(NC)"
	@if command -v air >/dev/null 2>&1; then \
		air; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  air not installed. Installing...$(NC)"; \
		go install github.com/cosmtrek/air@latest; \
		air; \
	fi

# Ki·ªÉm tra Go environment
check:
	@echo "$(GREEN)üîç Checking Go environment...$(NC)"
	@echo "Go version: $$(go version)"
	@echo "GOPATH: $$(go env GOPATH)"
	@echo "GOROOT: $$(go env GOROOT)"

# Ch·∫°y database v√† server c√πng l√∫c
all: docker-db run

# Quick start
quick: tidy docker-db
	@sleep 2
	@make run

# Set user th√†nh admin
set-admin:
	@if [ -z "$(EMAIL)" ]; then \
		echo "$(RED)‚ùå Vui l√≤ng cung c·∫•p email: make set-admin EMAIL=user@example.com$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)üîß Setting user $(EMAIL) as admin...$(NC)"
	@docker exec -i $$(docker ps -q -f name=postgres) psql -U postgres -d hst_db -c "UPDATE nguoi_dung SET vai_tro = 'admin', thoi_gian_cap_nhat = NOW() WHERE email = '$(EMAIL)';"
	@docker exec -i $$(docker ps -q -f name=postgres) psql -U postgres -d hst_db -c "SELECT id, email, ten, vai_tro FROM nguoi_dung WHERE email = '$(EMAIL)';"
	@echo "$(GREEN)‚úÖ User ƒë√£ ƒë∆∞·ª£c set th√†nh admin$(NC)"
